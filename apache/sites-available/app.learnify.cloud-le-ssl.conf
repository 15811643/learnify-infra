<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName app.learnify.cloud

    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/app.learnify.cloud/fullchain.pem  
    SSLCertificateKeyFile /etc/letsencrypt/live/app.learnify.cloud/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    # HEALTH BYPASS (no auth) â€” BOTH blue + green must work
    # Keep these ABOVE any catch-all ProxyPass "/"

    # Explicit checks (always available)
    ProxyPass        /ops/health/blue   http://127.0.0.1:18081/ops/health
    ProxyPassReverse /ops/health/blue   http://127.0.0.1:18081/ops/health

    ProxyPass        /ops/health/green  http://127.0.0.1:18082/ops/health
    ProxyPassReverse /ops/health/green  http://127.0.0.1:18082/ops/health

    ProxyPass        /health/blue       http://127.0.0.1:18081/health
    ProxyPassReverse /health/blue       http://127.0.0.1:18081/health

    ProxyPass        /health/green      http://127.0.0.1:18082/health
    ProxyPassReverse /health/green      http://127.0.0.1:18082/health

    # Default health (choose one "active" target; switch when flipping live)
    ProxyPass        /ops/health        http://127.0.0.1:18082/ops/health
    ProxyPassReverse /ops/health        http://127.0.0.1:18082/ops/health

    ProxyPass        /health            http://127.0.0.1:18082/health
    ProxyPassReverse /health            http://127.0.0.1:18082/health

    # oauth2-proxy endpoints
    ProxyPass        /oauth2/ http://127.0.0.1:4180/oauth2/
    ProxyPassReverse /oauth2/ http://127.0.0.1:4180/oauth2/

    # all other traffic through oauth2-proxy (auth front door)
    ProxyPass        / http://127.0.0.1:4180/
    ProxyPassReverse / http://127.0.0.1:4180/

</VirtualHost>
</IfModule>
